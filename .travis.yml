language: go

go:
  - 1.12.x


branches:
  only:
    - master
    - /^v\d+\.\d+\.\d+(-.*)?$/
    - /^v\d+$/


stages:
  - name: style
    if: type == pull_request
  - name: test
  - name: deploy
    if: type == push


jobs:
  include:
    - stage: style
      name: "Style check"
      script: make stylecheck
    - stage: test
      name: "Unit tests"
      if: tag IS NOT present
      script: make test
      after_success:
        - bash <(curl -s https://codecov.io/bash)
    - stage: deploy
      name: "Update goreportcard"
      script: curl --fail --request POST "https://goreportcard.com/checks" --data "repo=github.com/SVilgelm/bumptag"
      if: branch = master
    - stage: deploy
      name: "Upload binaries"
      if: tag IS present
      before_install:
        - openssl aes-256-cbc -K $encrypted_63a44db3708e_key -iv $encrypted_63a44db3708e_iv -in .extra/build/bumptag.gpg.enc -out bumptag.gpg -d
        - gpg --import bumptag.gpg
      script:
        - make build-all
      deploy:
        provider: releases
        api_key: ${GITHUB_TOKEN}
        on:
          tags: true
        skip_cleanup: true
        file_glob: true
        file: .build/*
